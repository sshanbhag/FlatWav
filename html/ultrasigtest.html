
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ultrasigtest</title><meta name="generator" content="MATLAB 7.11.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2012-10-03"><meta name="DC.source" content="ultrasigtest.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">load dummy calibration  data</a></li><li><a href="#3">synthesize test noise from min(F) to max(F)</a></li><li><a href="#4">use compensate signal to compensate with BOOST</a></li><li><a href="#5">test atten method</a></li></ul></div><pre class="codeinput"><span class="comment">% frequencies</span>
Fs = 500000;
Fmin = 100;
Fmax = 110000;
stimdur = 500;
corr_frange = [2000 100000];

MIN_DB = -120;
</pre><h2>load dummy calibration  data<a name="2"></a></h2><pre class="codeinput">caldata = fake_caldata(<span class="string">'FREQS'</span>, 100:100:120000);

<span class="comment">% assign meaningful values to caldata.mag</span>
x = 2*pi*linspace(0, 1, length(caldata.mag(1, :)));
m = 20 * sin(x);
caldata.mag = [m; m];

<span class="comment">% shorter names for freq and mag from caldata</span>
F = caldata.freq;
M = caldata.mag(1, :);

<span class="comment">% plot</span>
figure(1)
plot(0.001*F, M, <span class="string">'.-'</span>)
xlabel(<span class="string">'Frequency (kHz)'</span>)
ylabel(<span class="string">'dB SPL'</span>)
title(<span class="string">'System Transfer Function'</span>)
</pre><img vspace="5" hspace="5" src="ultrasigtest_01.png" alt=""> <h2>synthesize test noise from min(F) to max(F)<a name="3"></a></h2><pre class="codeinput">s = synmononoise_fft(stimdur, Fs, Fmin, Fmax, 1, 0);
s = normalize(s);
s = sin2array(s, 5, Fs);

<span class="comment">% s = synmonosine(stimdur, Fs, Fsine, 1, 0);</span>
<span class="comment">% plot spectrum of s</span>
[fraw, magraw, phiraw] = daqdbfullfft(s, Fs, length(s));
figure(2)
tvec = 1000 * (0:(length(s)-1)) ./ Fs;
subplot(331)
plot(tvec, s)
title(<span class="string">'Test signal'</span>)
xlabel(<span class="string">'time (milliseconds)'</span>)
ylabel(<span class="string">'V'</span>)

subplot(332)
plot(0.001*fraw, magraw);
title(<span class="string">'Test Signal Magnitude'</span>)
xlabel(<span class="string">'freq (kHz)'</span>)
ylabel(<span class="string">'dB'</span>)
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(333)
plot(0.001*fraw, phiraw);
title(<span class="string">'Test Signal Phase'</span>);
xlabel(<span class="string">'freq (kHz)'</span>);
ylabel(<span class="string">'rad'</span>);
xlim([0 0.001*Fs/2]);
</pre><img vspace="5" hspace="5" src="ultrasigtest_02.png" alt=""> <h2>use compensate signal to compensate with BOOST<a name="4"></a></h2><pre class="codeinput">[sadj, Sfull, Hnorm, foutadj] = compensate_signal(s, F, M, Fs, corr_frange, <span class="string">'Method'</span>, <span class="string">'BOOST'</span>, <span class="string">'Normalize'</span>, <span class="string">'on'</span>, <span class="string">'Lowcut'</span>, <span class="string">'off'</span>);

<span class="comment">% plot compensated signal</span>
[fadj, magadj, phiadj] = daqdbfullfft(sadj, Fs, length(sadj));
figure(2)
subplot(334)
plot(tvec, sadj)
title(<span class="string">'Boost Comp Signal'</span>)
xlabel(<span class="string">'time (milliseconds)'</span>)
ylabel(<span class="string">'V'</span>)

subplot(335)
plot(0.001*fadj, magadj);
title(<span class="string">'Boost Comp Magn.'</span>)
xlabel(<span class="string">'freq (kHz)'</span>)
ylabel(<span class="string">'dB'</span>)
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(336)
plot(0.001*fadj, phiadj);
title(<span class="string">'Boost Comp Phase'</span>);
xlabel(<span class="string">'freq (kHz)'</span>);
ylabel(<span class="string">'rad'</span>);
xlim([0 0.001*Fs/2]);
</pre><img vspace="5" hspace="5" src="ultrasigtest_03.png" alt=""> <h2>test atten method<a name="5"></a></h2><p>apply correction (ATTEN method)</p><pre class="codeinput">[aadj, Afull, Hnorm, foutadj] = compensate_signal(s, F, M, Fs, corr_frange, <span class="string">'Method'</span>, <span class="string">'ATTEN'</span>, <span class="string">'Normalize'</span>, <span class="string">'on'</span>, <span class="string">'Lowcut'</span>, <span class="string">'off'</span>);

figure(2)
<span class="comment">% plot compensated signal</span>
[faadj, magaadj, phiaadj] = daqdbfullfft(aadj, Fs, length(aadj));
subplot(337)
plot(tvec, aadj)
title(<span class="string">'Atten Comp Signal'</span>)
xlabel(<span class="string">'time (milliseconds)'</span>)
ylabel(<span class="string">'V'</span>)

subplot(338)
plot(0.001*faadj, magaadj);
title(<span class="string">'Atten Comp Spectrum'</span>)
xlabel(<span class="string">'freq (kHz)'</span>)
ylabel(<span class="string">'dB'</span>)
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(339)
plot(0.001*faadj, phiaadj);
title(<span class="string">'Atten Comp Phase'</span>);
xlabel(<span class="string">'freq (kHz)'</span>);
ylabel(<span class="string">'rad'</span>);
xlim([0 0.001*Fs/2]);
</pre><img vspace="5" hspace="5" src="ultrasigtest_04.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.11.1<br></p></div><!--
##### SOURCE BEGIN #####
% frequencies
Fs = 500000;
Fmin = 100;
Fmax = 110000;
stimdur = 500;
corr_frange = [2000 100000];

MIN_DB = -120;


%% load dummy calibration  data
caldata = fake_caldata('FREQS', 100:100:120000);

% assign meaningful values to caldata.mag
x = 2*pi*linspace(0, 1, length(caldata.mag(1, :)));
m = 20 * sin(x);
caldata.mag = [m; m];

% shorter names for freq and mag from caldata
F = caldata.freq;
M = caldata.mag(1, :);

% plot
figure(1)
plot(0.001*F, M, '.-')
xlabel('Frequency (kHz)')
ylabel('dB SPL')
title('System Transfer Function')

%% synthesize test noise from min(F) to max(F)
s = synmononoise_fft(stimdur, Fs, Fmin, Fmax, 1, 0);
s = normalize(s);
s = sin2array(s, 5, Fs);

% s = synmonosine(stimdur, Fs, Fsine, 1, 0);
% plot spectrum of s
[fraw, magraw, phiraw] = daqdbfullfft(s, Fs, length(s));
figure(2)
tvec = 1000 * (0:(length(s)-1)) ./ Fs;
subplot(331)
plot(tvec, s)
title('Test signal')
xlabel('time (milliseconds)')
ylabel('V')

subplot(332)
plot(0.001*fraw, magraw);
title('Test Signal Magnitude')
xlabel('freq (kHz)')
ylabel('dB')
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(333)
plot(0.001*fraw, phiraw);
title('Test Signal Phase');
xlabel('freq (kHz)');
ylabel('rad');
xlim([0 0.001*Fs/2]);

%% use compensate signal to compensate with BOOST
[sadj, Sfull, Hnorm, foutadj] = compensate_signal(s, F, M, Fs, corr_frange, 'Method', 'BOOST', 'Normalize', 'on', 'Lowcut', 'off');

% plot compensated signal
[fadj, magadj, phiadj] = daqdbfullfft(sadj, Fs, length(sadj));
figure(2)
subplot(334)
plot(tvec, sadj)
title('Boost Comp Signal')
xlabel('time (milliseconds)')
ylabel('V')

subplot(335)
plot(0.001*fadj, magadj);
title('Boost Comp Magn.')
xlabel('freq (kHz)')
ylabel('dB')
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(336)
plot(0.001*fadj, phiadj);
title('Boost Comp Phase');
xlabel('freq (kHz)');
ylabel('rad');
xlim([0 0.001*Fs/2]);

%% test atten method
% apply correction (ATTEN method)
[aadj, Afull, Hnorm, foutadj] = compensate_signal(s, F, M, Fs, corr_frange, 'Method', 'ATTEN', 'Normalize', 'on', 'Lowcut', 'off');

figure(2)
% plot compensated signal
[faadj, magaadj, phiaadj] = daqdbfullfft(aadj, Fs, length(aadj));
subplot(337)
plot(tvec, aadj)
title('Atten Comp Signal')
xlabel('time (milliseconds)')
ylabel('V')

subplot(338)
plot(0.001*faadj, magaadj);
title('Atten Comp Spectrum')
xlabel('freq (kHz)')
ylabel('dB')
ylim([-120 0])
xlim([0 0.001*Fs/2])

subplot(339)
plot(0.001*faadj, phiaadj);
title('Atten Comp Phase');
xlabel('freq (kHz)');
ylabel('rad');
xlim([0 0.001*Fs/2]);

##### SOURCE END #####
--></body></html>